# 我的附近API测试指南\n\n## API接口信息\n\n**接口地址：** `GET /api/nearby/my-nearby`\n\n**功能描述：** 获取用户实时位置和附近寄存点信息，支持IP定位和GPS定位\n\n## 测试用例\n\n### 1. IP定位测试\n\n```bash\n# 基础IP定位（使用服务器自动获取客户端IP）\ncurl -X GET \"http://localhost:8000/api/nearby/my-nearby\" \\\n  -H \"Content-Type: application/json\"\n```\n\n```bash\n# 指定搜索参数\ncurl -X GET \"http://localhost:8000/api/nearby/my-nearby?radius=10&limit=30\" \\\n  -H \"Content-Type: application/json\"\n```\n\n### 2. GPS定位测试\n\n```bash\n# 使用GPS坐标（北京天安门附近）\ncurl -X GET \"http://localhost:8000/api/nearby/my-nearby?longitude=116.397428&latitude=39.90923&radius=5&limit=20\" \\\n  -H \"Content-Type: application/json\"\n```\n\n```bash\n# 使用GPS坐标（上海外滩附近）\ncurl -X GET \"http://localhost:8000/api/nearby/my-nearby?longitude=121.499809&latitude=31.245105&radius=3&limit=15\" \\\n  -H \"Content-Type: application/json\"\n```\n\n### 3. 混合参数测试\n\n```bash\n# 提供IP和GPS坐标（GPS优先）\ncurl -X GET \"http://localhost:8000/api/nearby/my-nearby?ip=123.123.123.123&longitude=116.404&latitude=39.915&radius=8&limit=25\" \\\n  -H \"Content-Type: application/json\"\n```\n\n## 预期响应格式\n\n### 成功响应示例\n\n```json\n{\n  \"user_location\": {\n    \"longitude\": 116.397428,\n    \"latitude\": 39.90923,\n    \"address\": \"北京市东城区天安门广场\",\n    \"city\": \"北京市\",\n    \"district\": \"东城区\",\n    \"province\": \"北京市\",\n    \"location_type\": \"gps\"\n  },\n  \"nearby_points\": [\n    {\n      \"id\": 1,\n      \"name\": \"天安门寄存点\",\n      \"address\": \"北京市东城区天安门广场东侧\",\n      \"distance\": 0.2,\n      \"longitude\": 116.398,\n      \"latitude\": 39.909\n    },\n    {\n      \"id\": 2,\n      \"name\": \"故宫寄存点\",\n      \"address\": \"北京市东城区故宫博物院南门\",\n      \"distance\": 0.8,\n      \"longitude\": 116.397,\n      \"latitude\": 39.916\n    }\n  ],\n  \"total_count\": 2,\n  \"search_radius\": 5.0,\n  \"baidu_map_ak\": \"7pzoTHchDdMRK7jmpCr1sugjv3hfoxz5\"\n}\n```\n\n### 错误响应示例\n\n```json\n{\n  \"code\": 500,\n  \"message\": \"获取我的附近信息失败: 百度地图API调用失败\",\n  \"reason\": \"NEARBY_INTERNAL_ERROR\"\n}\n```\n\n## 参数说明\n\n| 参数名 | 类型 | 必填 | 默认值 | 说明 |\n|--------|------|------|--------|------|\n| ip | string | 否 | - | 用户IP地址，用于IP定位 |\n| longitude | double | 否 | - | 用户经度，GPS定位时提供 |\n| latitude | double | 否 | - | 用户纬度，GPS定位时提供 |\n| radius | double | 否 | 5.0 | 搜索半径（公里） |\n| limit | int64 | 否 | 20 | 返回寄存点数量限制 |\n\n## 定位优先级\n\n1. **GPS定位**：如果提供了longitude和latitude参数，优先使用GPS定位\n2. **IP定位**：如果提供了ip参数，使用百度地图IP定位API\n3. **默认位置**：如果以上都没有提供或失败，使用北京天安门作为默认位置\n\n## 前端集成示例\n\n### JavaScript调用示例\n\n```javascript\n// 1. IP定位方式\nasync function getMyNearbyByIP() {\n  try {\n    const response = await fetch('/api/nearby/my-nearby');\n    const data = await response.json();\n    \n    console.log('用户位置:', data.user_location);\n    console.log('附近寄存点:', data.nearby_points);\n    \n    // 初始化百度地图\n    initBaiduMap(data.user_location, data.nearby_points, data.baidu_map_ak);\n    \n  } catch (error) {\n    console.error('获取我的附近信息失败:', error);\n  }\n}\n\n// 2. GPS定位方式\nfunction getMyNearbyByGPS() {\n  if (navigator.geolocation) {\n    navigator.geolocation.getCurrentPosition(async (position) => {\n      const { longitude, latitude } = position.coords;\n      \n      try {\n        const params = new URLSearchParams({\n          longitude: longitude.toString(),\n          latitude: latitude.toString(),\n          radius: '5',\n          limit: '20'\n        });\n        \n        const response = await fetch(`/api/nearby/my-nearby?${params}`);\n        const data = await response.json();\n        \n        // 处理响应数据\n        handleNearbyData(data);\n        \n      } catch (error) {\n        console.error('获取我的附近信息失败:', error);\n      }\n    });\n  }\n}\n\n// 3. 初始化百度地图\nfunction initBaiduMap(userLocation, nearbyPoints, baiduMapAk) {\n  // 创建地图实例\n  const map = new BMap.Map('mapContainer');\n  \n  // 设置地图中心点为用户位置\n  const userPoint = new BMap.Point(userLocation.longitude, userLocation.latitude);\n  map.centerAndZoom(userPoint, 15);\n  \n  // 添加用户位置标记\n  const userMarker = new BMap.Marker(userPoint);\n  map.addOverlay(userMarker);\n  \n  // 添加寄存点标记\n  nearbyPoints.forEach(point => {\n    const lockerPoint = new BMap.Point(point.longitude, point.latitude);\n    const lockerMarker = new BMap.Marker(lockerPoint);\n    map.addOverlay(lockerMarker);\n    \n    // 添加信息窗口\n    const infoWindow = new BMap.InfoWindow(`\n      <div>\n        <h4>${point.name}</h4>\n        <p>${point.address}</p>\n        <p>距离: ${point.distance.toFixed(2)} 公里</p>\n      </div>\n    `);\n    \n    lockerMarker.addEventListener('click', () => {\n      map.openInfoWindow(infoWindow, lockerPoint);\n    });\n  });\n}\n```\n\n### HTML页面示例\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n    <meta charset=\"utf-8\">\n    <title>我的附近 - 寄存点地图</title>\n    <script type=\"text/javascript\" src=\"https://api.map.baidu.com/api?v=3.0&ak=YOUR_BAIDU_MAP_AK\"></script>\n</head>\n<body>\n    <div id=\"mapContainer\" style=\"width: 100%; height: 500px;\"></div>\n    <button onclick=\"getMyNearbyByIP()\">IP定位查找附近</button>\n    <button onclick=\"getMyNearbyByGPS()\">GPS定位查找附近</button>\n    \n    <script>\n        // 在这里添加上面的JavaScript代码\n    </script>\n</body>\n</html>\n```\n\n## 测试步骤\n\n### 1. 启动服务\n\n```bash\n# 启动后端服务\ngo run cmd/ito-deposit/main.go\n```\n\n### 2. 测试API接口\n\n```bash\n# 测试基础功能\ncurl -X GET \"http://localhost:8000/api/nearby/my-nearby\"\n\n# 测试GPS定位\ncurl -X GET \"http://localhost:8000/api/nearby/my-nearby?longitude=116.404&latitude=39.915\"\n```\n\n### 3. 测试前端页面\n\n1. 打开 `web/my_nearby.html` 文件\n2. 点击\"查找我的附近\"按钮测试IP定位\n3. 点击\"使用GPS定位\"按钮测试GPS定位\n4. 查看地图上的用户位置和寄存点标记\n5. 点击寄存点标记查看详细信息\n\n## 常见问题\n\n### 1. 百度地图API调用失败\n\n**原因：** 百度地图AK配置错误或网络问题\n\n**解决方案：**\n- 检查百度地图AK是否正确\n- 确认AK的服务权限设置\n- 检查网络连接\n\n### 2. GPS定位失败\n\n**原因：** 浏览器不支持或用户拒绝授权\n\n**解决方案：**\n- 使用HTTPS协议\n- 引导用户允许位置访问权限\n- 提供IP定位作为备选方案\n\n### 3. 附近没有寄存点\n\n**原因：** 数据库中没有该区域的寄存点数据\n\n**解决方案：**\n- 增加搜索半径\n- 添加更多寄存点数据\n- 提供其他城市的寄存点推荐\n\n## 性能优化建议\n\n1. **缓存用户位置**：避免频繁调用定位API\n2. **合理设置搜索半径**：根据城市密度调整搜索范围\n3. **限制返回数量**：避免返回过多数据影响性能\n4. **使用CDN**：加速百度地图API加载\n5. **错误重试机制**：定位失败时提供重试选项\n\n这个API为前端提供了完整的\"我的附近\"功能支持，可以很好地集成百度地图显示用户位置和附近寄存点。"