<!DOCTYPE html>\n<html>\n<head>\n    <meta charset=\"utf-8\">\n    <title>我的附近 - 寄存点地图</title>\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <style>\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n        \n        body {\n            font-family: 'Microsoft YaHei', Arial, sans-serif;\n            background-color: #f5f5f5;\n        }\n        \n        .header {\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n            color: white;\n            padding: 20px;\n            text-align: center;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n        }\n        \n        .header h1 {\n            font-size: 24px;\n            margin-bottom: 10px;\n        }\n        \n        .header p {\n            opacity: 0.9;\n            font-size: 14px;\n        }\n        \n        .container {\n            max-width: 1200px;\n            margin: 0 auto;\n            padding: 20px;\n        }\n        \n        .controls {\n            background: white;\n            padding: 20px;\n            border-radius: 10px;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n            margin-bottom: 20px;\n            text-align: center;\n        }\n        \n        .btn {\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n            color: white;\n            border: none;\n            padding: 12px 24px;\n            border-radius: 25px;\n            cursor: pointer;\n            font-size: 16px;\n            margin: 0 10px;\n            transition: all 0.3s ease;\n            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);\n        }\n        \n        .btn:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);\n        }\n        \n        .btn:disabled {\n            background: #ccc;\n            cursor: not-allowed;\n            transform: none;\n            box-shadow: none;\n        }\n        \n        .map-container {\n            width: 100%;\n            height: 500px;\n            border-radius: 10px;\n            overflow: hidden;\n            box-shadow: 0 4px 20px rgba(0,0,0,0.1);\n            margin-bottom: 20px;\n            display: none;\n        }\n        \n        .info-panel {\n            background: white;\n            border-radius: 10px;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n            overflow: hidden;\n            display: none;\n        }\n        \n        .location-info {\n            padding: 20px;\n            border-bottom: 1px solid #eee;\n        }\n        \n        .location-info h3 {\n            color: #333;\n            margin-bottom: 15px;\n            font-size: 18px;\n        }\n        \n        .location-details {\n            color: #666;\n            line-height: 1.6;\n        }\n        \n        .location-details p {\n            margin-bottom: 8px;\n        }\n        \n        .nearby-points {\n            padding: 20px;\n        }\n        \n        .nearby-points h3 {\n            color: #333;\n            margin-bottom: 15px;\n            font-size: 18px;\n        }\n        \n        .point-item {\n            background: #f8f9fa;\n            padding: 15px;\n            margin-bottom: 10px;\n            border-radius: 8px;\n            border-left: 4px solid #667eea;\n            cursor: pointer;\n            transition: all 0.3s ease;\n        }\n        \n        .point-item:hover {\n            background: #e9ecef;\n            transform: translateX(5px);\n        }\n        \n        .point-name {\n            font-weight: bold;\n            color: #333;\n            font-size: 16px;\n            margin-bottom: 5px;\n        }\n        \n        .point-address {\n            color: #666;\n            font-size: 14px;\n            margin-bottom: 5px;\n        }\n        \n        .point-distance {\n            color: #667eea;\n            font-size: 12px;\n            font-weight: bold;\n        }\n        \n        .loading {\n            text-align: center;\n            padding: 40px;\n            color: #666;\n            background: white;\n            border-radius: 10px;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n            display: none;\n        }\n        \n        .loading-spinner {\n            width: 40px;\n            height: 40px;\n            border: 4px solid #f3f3f3;\n            border-top: 4px solid #667eea;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n            margin: 0 auto 20px;\n        }\n        \n        @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n        }\n        \n        .error {\n            background: #f8d7da;\n            color: #721c24;\n            padding: 15px;\n            border-radius: 8px;\n            margin-bottom: 20px;\n            border-left: 4px solid #dc3545;\n            display: none;\n        }\n        \n        .success {\n            background: #d4edda;\n            color: #155724;\n            padding: 15px;\n            border-radius: 8px;\n            margin-bottom: 20px;\n            border-left: 4px solid #28a745;\n            display: none;\n        }\n        \n        .stats {\n            display: flex;\n            justify-content: space-around;\n            background: white;\n            padding: 20px;\n            border-radius: 10px;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n            margin-bottom: 20px;\n            display: none;\n        }\n        \n        .stat-item {\n            text-align: center;\n        }\n        \n        .stat-number {\n            font-size: 24px;\n            font-weight: bold;\n            color: #667eea;\n            display: block;\n        }\n        \n        .stat-label {\n            font-size: 14px;\n            color: #666;\n            margin-top: 5px;\n        }\n    </style>\n</head>\n<body>\n    <div class=\"header\">\n        <h1>🗺️ 我的附近</h1>\n        <p>查找您附近的寄存点，让存取更便捷</p>\n    </div>\n    \n    <div class=\"container\">\n        <div class=\"controls\">\n            <button id=\"findMyLocationBtn\" class=\"btn\">📍 查找我的附近</button>\n            <button id=\"useGpsBtn\" class=\"btn\">🛰️ 使用GPS定位</button>\n        </div>\n        \n        <div id=\"errorMessage\" class=\"error\"></div>\n        <div id=\"successMessage\" class=\"success\"></div>\n        \n        <div id=\"loadingMessage\" class=\"loading\">\n            <div class=\"loading-spinner\"></div>\n            <p>正在获取您的位置信息和附近寄存点...</p>\n        </div>\n        \n        <div id=\"statsPanel\" class=\"stats\">\n            <div class=\"stat-item\">\n                <span id=\"pointCount\" class=\"stat-number\">0</span>\n                <div class=\"stat-label\">附近寄存点</div>\n            </div>\n            <div class=\"stat-item\">\n                <span id=\"searchRadius\" class=\"stat-number\">5</span>\n                <div class=\"stat-label\">搜索半径(km)</div>\n            </div>\n            <div class=\"stat-item\">\n                <span id=\"locationType\" class=\"stat-number\">-</span>\n                <div class=\"stat-label\">定位方式</div>\n            </div>\n        </div>\n        \n        <div id=\"mapContainer\" class=\"map-container\"></div>\n        \n        <div id=\"infoPanel\" class=\"info-panel\">\n            <div class=\"location-info\">\n                <h3>📍 您的位置</h3>\n                <div id=\"locationDetails\" class=\"location-details\"></div>\n            </div>\n            \n            <div class=\"nearby-points\">\n                <h3>🏪 附近寄存点</h3>\n                <div id=\"pointsList\"></div>\n            </div>\n        </div>\n    </div>\n\n    <!-- 百度地图API -->\n    <script type=\"text/javascript\" src=\"https://api.map.baidu.com/api?v=3.0&ak=7pzoTHchDdMRK7jmpCr1sugjv3hfoxz5\"></script>\n    \n    <script>\n        // 全局变量\n        let map = null;\n        let userMarker = null;\n        let lockerMarkers = [];\n        let currentUserLocation = null;\n        \n        // API配置\n        const API_BASE_URL = 'http://localhost:8000';\n        \n        // DOM元素\n        const findMyLocationBtn = document.getElementById('findMyLocationBtn');\n        const useGpsBtn = document.getElementById('useGpsBtn');\n        const errorMessage = document.getElementById('errorMessage');\n        const successMessage = document.getElementById('successMessage');\n        const loadingMessage = document.getElementById('loadingMessage');\n        const mapContainer = document.getElementById('mapContainer');\n        const infoPanel = document.getElementById('infoPanel');\n        const statsPanel = document.getElementById('statsPanel');\n        const locationDetails = document.getElementById('locationDetails');\n        const pointCount = document.getElementById('pointCount');\n        const searchRadius = document.getElementById('searchRadius');\n        const locationType = document.getElementById('locationType');\n        const pointsList = document.getElementById('pointsList');\n        \n        // 事件监听器\n        findMyLocationBtn.addEventListener('click', findMyLocationByIP);\n        useGpsBtn.addEventListener('click', findMyLocationByGPS);\n        \n        // 通过IP定位查找我的附近\n        async function findMyLocationByIP() {\n            showLoading(true);\n            hideMessages();\n            \n            try {\n                const response = await fetch(`${API_BASE_URL}/api/nearby/my-nearby`, {\n                    method: 'GET',\n                    headers: {\n                        'Content-Type': 'application/json',\n                    }\n                });\n                \n                if (!response.ok) {\n                    const errorData = await response.json();\n                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);\n                }\n                \n                const data = await response.json();\n                handleNearbyInfoResponse(data);\n                showSuccess('成功获取您的位置和附近寄存点信息！');\n                \n            } catch (error) {\n                console.error('获取我的附近信息失败:', error);\n                showError(`获取位置信息失败：${error.message}`);\n            } finally {\n                showLoading(false);\n            }\n        }\n        \n        // 通过GPS定位查找我的附近\n        function findMyLocationByGPS() {\n            if (!navigator.geolocation) {\n                showError('您的浏览器不支持GPS定位功能。');\n                return;\n            }\n            \n            showLoading(true);\n            hideMessages();\n            \n            navigator.geolocation.getCurrentPosition(\n                async (position) => {\n                    const { longitude, latitude } = position.coords;\n                    \n                    try {\n                        const params = new URLSearchParams({\n                            longitude: longitude.toString(),\n                            latitude: latitude.toString(),\n                            radius: '5',\n                            limit: '20'\n                        });\n                        \n                        const response = await fetch(`${API_BASE_URL}/api/nearby/my-nearby?${params}`, {\n                            method: 'GET',\n                            headers: {\n                                'Content-Type': 'application/json',\n                            }\n                        });\n                        \n                        if (!response.ok) {\n                            const errorData = await response.json();\n                            throw new Error(errorData.message || `HTTP error! status: ${response.status}`);\n                        }\n                        \n                        const data = await response.json();\n                        handleNearbyInfoResponse(data);\n                        showSuccess('GPS定位成功，已为您找到附近的寄存点！');\n                        \n                    } catch (error) {\n                        console.error('获取我的附近信息失败:', error);\n                        showError(`获取附近寄存点信息失败：${error.message}`);\n                    } finally {\n                        showLoading(false);\n                    }\n                },\n                (error) => {\n                    showLoading(false);\n                    let errorMsg = 'GPS定位失败：';\n                    switch (error.code) {\n                        case error.PERMISSION_DENIED:\n                            errorMsg += '请允许浏览器访问您的位置信息。';\n                            break;\n                        case error.POSITION_UNAVAILABLE:\n                            errorMsg += '无法获取您的位置信息。';\n                            break;\n                        case error.TIMEOUT:\n                            errorMsg += '定位请求超时。';\n                            break;\n                        default:\n                            errorMsg += '未知错误。';\n                            break;\n                    }\n                    showError(errorMsg);\n                },\n                {\n                    enableHighAccuracy: true,\n                    timeout: 10000,\n                    maximumAge: 300000\n                }\n            );\n        }\n        \n        // 处理我的附近信息响应\n        function handleNearbyInfoResponse(data) {\n            currentUserLocation = data.user_location;\n            \n            // 更新统计信息\n            updateStats(data);\n            \n            // 显示用户位置信息\n            displayUserLocation(data.user_location);\n            \n            // 显示附近寄存点列表\n            displayNearbyPoints(data.nearby_points);\n            \n            // 初始化百度地图\n            initBaiduMap(data.user_location, data.nearby_points);\n            \n            // 显示所有面板\n            statsPanel.style.display = 'flex';\n            mapContainer.style.display = 'block';\n            infoPanel.style.display = 'block';\n        }\n        \n        // 更新统计信息\n        function updateStats(data) {\n            pointCount.textContent = data.total_count;\n            searchRadius.textContent = data.search_radius;\n            \n            const locationTypeText = {\n                'gps': 'GPS',\n                'ip': 'IP定位',\n                'default': '默认'\n            };\n            locationType.textContent = locationTypeText[data.user_location.location_type] || data.user_location.location_type;\n        }\n        \n        // 显示用户位置信息\n        function displayUserLocation(userLocation) {\n            const locationTypeText = {\n                'gps': 'GPS定位',\n                'ip': 'IP定位',\n                'default': '默认位置'\n            };\n            \n            locationDetails.innerHTML = `\n                <p><strong>📍 地址：</strong>${userLocation.address}</p>\n                <p><strong>🏙️ 城市：</strong>${userLocation.province} ${userLocation.city} ${userLocation.district}</p>\n                <p><strong>🌐 坐标：</strong>${userLocation.longitude.toFixed(6)}, ${userLocation.latitude.toFixed(6)}</p>\n                <p><strong>🔍 定位方式：</strong>${locationTypeText[userLocation.location_type] || userLocation.location_type}</p>\n            `;\n        }\n        \n        // 显示附近寄存点列表\n        function displayNearbyPoints(nearbyPoints) {\n            if (nearbyPoints.length === 0) {\n                pointsList.innerHTML = '<p style=\"color: #666; text-align: center; padding: 20px;\">😔 附近暂无寄存点</p>';\n                return;\n            }\n            \n            pointsList.innerHTML = nearbyPoints.map((point, index) => `\n                <div class=\"point-item\" onclick=\"focusOnPoint(${point.longitude}, ${point.latitude})\">\n                    <div class=\"point-name\">🏪 ${point.name}</div>\n                    <div class=\"point-address\">📍 ${point.address}</div>\n                    <div class=\"point-distance\">📏 距离约 ${point.distance.toFixed(2)} 公里</div>\n                </div>\n            `).join('');\n        }\n        \n        // 初始化百度地图\n        function initBaiduMap(userLocation, nearbyPoints) {\n            // 创建地图实例\n            map = new BMap.Map('mapContainer');\n            \n            // 设置地图中心点为用户位置\n            const userPoint = new BMap.Point(userLocation.longitude, userLocation.latitude);\n            map.centerAndZoom(userPoint, 15);\n            \n            // 启用地图功能\n            map.enableScrollWheelZoom(true);\n            map.addControl(new BMap.NavigationControl());\n            map.addControl(new BMap.ScaleControl());\n            map.addControl(new BMap.OverviewMapControl());\n            \n            // 添加用户位置标记\n            const userIcon = new BMap.Icon(\n                'data:image/svg+xml;base64,' + btoa(`\n                    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"32\" height=\"32\" viewBox=\"0 0 32 32\">\n                        <circle cx=\"16\" cy=\"16\" r=\"12\" fill=\"#667eea\" stroke=\"white\" stroke-width=\"3\"/>\n                        <circle cx=\"16\" cy=\"16\" r=\"6\" fill=\"white\"/>\n                        <circle cx=\"16\" cy=\"16\" r=\"3\" fill=\"#667eea\"/>\n                    </svg>\n                `),\n                new BMap.Size(32, 32),\n                {\n                    anchor: new BMap.Size(16, 16)\n                }\n            );\n            \n            userMarker = new BMap.Marker(userPoint, { icon: userIcon });\n            map.addOverlay(userMarker);\n            \n            // 用户位置信息窗口\n            const userInfoWindow = new BMap.InfoWindow(`\n                <div style=\"padding: 15px; min-width: 250px;\">\n                    <h4 style=\"margin: 0 0 10px 0; color: #333; font-size: 16px;\">📍 您的位置</h4>\n                    <p style=\"margin: 5px 0; color: #666; font-size: 14px;\">${userLocation.address}</p>\n                    <p style=\"margin: 5px 0; color: #999; font-size: 12px;\">定位方式: ${userLocation.location_type}</p>\n                </div>\n            `);\n            userMarker.addEventListener('click', () => {\n                map.openInfoWindow(userInfoWindow, userPoint);\n            });\n            \n            // 添加寄存点标记\n            clearLockerMarkers();\n            nearbyPoints.forEach((point, index) => {\n                const lockerPoint = new BMap.Point(point.longitude, point.latitude);\n                \n                // 创建寄存点图标\n                const lockerIcon = new BMap.Icon(\n                    'data:image/svg+xml;base64,' + btoa(`\n                        <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"32\" height=\"32\" viewBox=\"0 0 32 32\">\n                            <circle cx=\"16\" cy=\"16\" r=\"12\" fill=\"#ff6b6b\" stroke=\"white\" stroke-width=\"2\"/>\n                            <text x=\"16\" y=\"20\" text-anchor=\"middle\" fill=\"white\" font-size=\"14\" font-weight=\"bold\">${index + 1}</text>\n                        </svg>\n                    `),\n                    new BMap.Size(32, 32),\n                    {\n                        anchor: new BMap.Size(16, 16)\n                    }\n                );\n                \n                const lockerMarker = new BMap.Marker(lockerPoint, { icon: lockerIcon });\n                map.addOverlay(lockerMarker);\n                lockerMarkers.push(lockerMarker);\n                \n                // 寄存点信息窗口\n                const lockerInfoWindow = new BMap.InfoWindow(`\n                    <div style=\"padding: 15px; min-width: 250px;\">\n                        <h4 style=\"margin: 0 0 10px 0; color: #333; font-size: 16px;\">${point.name}</h4>\n                        <p style=\"margin: 5px 0; color: #666; font-size: 14px;\">📍 ${point.address}</p>\n                        <p style=\"margin: 5px 0; color: #667eea; font-weight: bold;\">📏 距离约 ${point.distance.toFixed(2)} 公里</p>\n                        <div style=\"margin-top: 15px; text-align: center;\">\n                            <button onclick=\"navigateToPoint(${point.longitude}, ${point.latitude})\" \n                                    style=\"background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px;\">\n                                🧭 导航到这里\n                            </button>\n                        </div>\n                    </div>\n                `);\n                \n                lockerMarker.addEventListener('click', () => {\n                    map.openInfoWindow(lockerInfoWindow, lockerPoint);\n                });\n            });\n            \n            // 调整地图视野以包含所有标记\n            if (nearbyPoints.length > 0) {\n                const points = [userPoint, ...nearbyPoints.map(p => new BMap.Point(p.longitude, p.latitude))];\n                map.setViewport(points, { margins: [50, 50, 50, 50] });\n            }\n        }\n        \n        // 聚焦到指定寄存点\n        function focusOnPoint(longitude, latitude) {\n            if (map) {\n                const point = new BMap.Point(longitude, latitude);\n                map.centerAndZoom(point, 16);\n                \n                // 找到对应的标记并触发点击事件\n                const marker = lockerMarkers.find(marker => {\n                    const pos = marker.getPosition();\n                    return Math.abs(pos.lng - longitude) < 0.0001 && Math.abs(pos.lat - latitude) < 0.0001;\n                });\n                \n                if (marker) {\n                    // 模拟点击事件\n                    setTimeout(() => {\n                        marker.dispatchEvent(new Event('click'));\n                    }, 500);\n                }\n            }\n        }\n        \n        // 导航到指定点\n        function navigateToPoint(longitude, latitude) {\n            if (currentUserLocation) {\n                const url = `https://api.map.baidu.com/direction?origin=${currentUserLocation.latitude},${currentUserLocation.longitude}&destination=${latitude},${longitude}&mode=walking&src=webapp.nearby.lockers`;\n                window.open(url, '_blank');\n            }\n        }\n        \n        // 清除寄存点标记\n        function clearLockerMarkers() {\n            lockerMarkers.forEach(marker => {\n                map.removeOverlay(marker);\n            });\n            lockerMarkers = [];\n        }\n        \n        // 显示加载状态\n        function showLoading(show) {\n            loadingMessage.style.display = show ? 'block' : 'none';\n            findMyLocationBtn.disabled = show;\n            useGpsBtn.disabled = show;\n        }\n        \n        // 显示错误信息\n        function showError(message) {\n            errorMessage.textContent = message;\n            errorMessage.style.display = 'block';\n        }\n        \n        // 显示成功信息\n        function showSuccess(message) {\n            successMessage.textContent = message;\n            successMessage.style.display = 'block';\n            // 3秒后自动隐藏\n            setTimeout(() => {\n                successMessage.style.display = 'none';\n            }, 3000);\n        }\n        \n        // 隐藏所有消息\n        function hideMessages() {\n            errorMessage.style.display = 'none';\n            successMessage.style.display = 'none';\n        }\n        \n        // 页面加载完成后的初始化\n        document.addEventListener('DOMContentLoaded', function() {\n            console.log('我的附近页面已加载完成');\n            console.log('API地址:', API_BASE_URL);\n        });\n    </script>\n</body>\n</html>"