# 定时任务监听异常快递柜功能说明

## 功能概述

本功能通过定时任务每5分钟检查一次数据库中的异常快递柜，并将异常信息存储到Redis中，供管理员查看和处理。

## 实现架构

### 1. 定时任务服务器 (cronserver)
- 基于 `github.com/robfig/cron/v3` 实现
- 支持标准的cron表达式
- 集成到Kratos框架中

### 2. 通知服务 (NotifyService)
- 检查异常状态的快递柜（状态码：3-故障，4-超时未取，5-维护中）
- 将异常信息存储到Redis
- 提供通知查询接口

### 3. 数据结构

#### 异常快递柜信息
```go
type AbnormalLocker struct {
    ID        int64  `json:"id"`           // 快递柜ID
    PointName string `json:"point_name"`   // 网点名称
    Address   string `json:"address"`      // 网点地址
    Status    int    `json:"status"`       // 状态码
    Reason    string `json:"reason"`       // 异常原因
    Time      string `json:"time"`         // 检测时间
}
```

#### 通知消息
```go
type NotificationMessage struct {
    Type      string            `json:"type"`      // 消息类型
    Message   string            `json:"message"`   // 消息内容
    Lockers   []AbnormalLocker  `json:"lockers"`   // 异常快递柜列表
    Timestamp time.Time         `json:"timestamp"` // 时间戳
}
```

## 使用方法

### 1. 启动服务
```bash
# 在项目根目录执行
kratos run
```

### 2. 查看通知
```bash
# 获取通知列表
curl -X GET "http://localhost:8000/admin/notifications?limit=10"
```

### 3. 响应示例
```json
{
    "code": 200,
    "msg": "获取通知成功",
    "notifications": [
        {
            "type": "abnormal_locker_alert",
            "message": "发现 3 个异常快递柜，请及时处理",
            "lockers": [
                {
                    "id": 1,
                    "point_name": "北京西站南广场",
                    "address": "南广场进站口东侧",
                    "status": 3,
                    "reason": "故障",
                    "time": "2024-01-15 14:30:00"
                }
            ],
            "timestamp": "2024-01-15 14:30:00"
        }
    ]
}
```

## 配置说明

### 1. 定时任务频率
默认每5分钟执行一次，可在 `main.go` 中修改：
```go
// 每5分钟检查一次异常快递柜
cronSrv.Schedule("*/5 * * * *", func() {
    // 检查逻辑
})
```

### 2. Redis存储
- 键名格式：`notifications:YYYY-MM-DD`
- 过期时间：7天
- 存储格式：JSON字符串列表

### 3. 异常状态码
- `3`: 故障
- `4`: 超时未取
- `5`: 维护中

## 扩展功能

### 1. 添加新的异常类型
在 `notify_service.go` 的 `getAbnormalReason` 方法中添加新的状态码处理。

### 2. 修改检查频率
修改cron表达式，例如：
- `"*/1 * * * *"` - 每分钟检查
- `"0 */1 * * *"` - 每小时检查
- `"0 0 */1 * *"` - 每天检查

### 3. 添加通知方式
可以在 `SendNotification` 方法中添加邮件、短信等通知方式。

## 注意事项

1. 确保Redis服务正常运行
2. 数据库中的快递柜状态码需要与代码中的定义一致
3. 定时任务会在应用启动时自动开始执行 